<!DOCTYPE html>
<html lang="se">
<head>
    <title>Coolt spel</title>
   <!-- <script src="{{ url_for('static', filename='index.js') }}"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.4/socket.io.js" integrity="sha512-aMGMvNYu8Ue4G+fHa359jcPb1u+ytAF+P2SCb+PxrjCdO3n3ZTxJ30zuH39rimUggmTwmh2u7wvQsDTHESnmfQ==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='index.css') }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='apple-touch-icon.png') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon-16x16.png') }}">
    <link rel="manifest" href="{{ url_for('static', filename='site.webmanifest') }}">
    <script type="text/javascript" charset="utf-8">
        //    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js">


        document.addEventListener("DOMContentLoaded", function() {
            round = document.getElementById("round");

            var socket = io();
            var state;
            socket.emit("test", "connection made!")

            socket.on("game_state", function (ans) {
                console.log("State recived")
                state = ans;
                updateUI()
            })

            function updateUI() {
                // Updates the game ui with the info from the state
                console.log(`got the state : ${JSON.stringify(state)}`)

                // updating the round counter
                round.innerText = "Runda: " + state["round"].toString()


                // updating player info
                let parent = document.getElementById("parent")
                for (var child of parent.children) {
                    let playerId = child.id;
                    let playerHand = state["playerHands"][playerId];
                    p = document.getElementById("hand" + playerId)
                    // Set the text content of the paragraph to the player's hand array
                    p.innerText ="Hand: " + playerHand.join();
                }
            }

            // Agent
            socket.on("uiAgentRequest", function (data) {
                console.log(JSON.stringify(data))
                let request = data["request"];
                let agentID = data["agentID"];
                console.log("handling uiAgent:", agentID);

                agent_request(request, agentID, function(action) {
                    console.log(`${agentID} svarar med ${action.response.toString()} skickar till servern"`);
                    socket.emit("uiAgentResponse", JSON.stringify(action));
                });


            })

            function agent_request(type, id, callback) {
                let infoDiv = document.getElementById(id).querySelector("div");
                var ptag = document.createElement("p");
                let textContent = {
                    card2Play: "Index av kort att spela",
                    layCard: "ID av agent kort ska läggas på",
                    take_discard: "Discard är tom, tryck nej "
                }
                if (state["discardDeck"] && state["discardDeck"].length > 0){
                    textContent["take_discard"] = "ta " + state["discardDeck"][0].toString()
                }
                ptag.textContent = textContent[type];
                infoDiv.appendChild(ptag)
                let response = {"agentID": id, "response": "yes"}
                if (type !== "card2Play" && type !== "layCard") {
                    // gets the player div
                    var yesBtn = document.createElement("button");
                    var noBtn = document.createElement("button");

                    yesBtn.textContent = "Ja";
                    noBtn.textContent = "Nej";
                    yesBtn.onclick = function () {
                        callback(response);
                        yesBtn.remove();
                        noBtn.remove();
                        ptag.remove();
                    }

                    noBtn.onclick = function () {
                        response["response"] = "no"
                        callback(response);
                        yesBtn.remove();
                        noBtn.remove();
                        ptag.remove();

                    }
                    let infoDiv = document.getElementById(id).querySelector("div");
                    infoDiv.appendChild(yesBtn);
                    infoDiv.appendChild(noBtn);
                }
                else if(type === "card2Play"){
                    let inputBox = document.createElement("input")
                    inputBox.type = "text";
                    let submitButton = document.createElement("button");
                    submitButton.textContent = "submit";
                    submitButton.onclick = function () {
                        response["response"] = inputBox.value;
                        callback(response)
                        submitButton.remove();
                        inputBox.remove();
                        ptag.remove();
                    }
                    infoDiv.appendChild(inputBox);
                    infoDiv.appendChild(submitButton);
                }
            }
        });


    </script>
</head>
<body>
<span>
    <h1 id="round"></h1>
</span>
<div id="parent">
    <div id="1">
        <h1>p1</h1>
        <div>
            <p id="hand1"></p>
        </div>
    </div>
    <div id="2">
        <h1>p2</h1>
        <div>
            <p id="hand2"></p>
        </div>
    </div>
    <div id="3">
        <h1>p3</h1>
        <div>
            <p id="hand3"></p>
        </div>
    </div>
    <div id="4">
        <h1>p4</h1>
        <div>
            <p id="hand4"></p>
        </div>
    </div>
    <div id="5">
        <h1>p5</h1>
        <div>
            <p id="hand5"></p>
        </div>
    </div>
</div>


</body>
</html>
